%   This function applies weighted pseudo inverse method for spectral estimation from colorimetry and returns estimated spectra
%
%   Example:
%   S = wpseudoInv(test, training, illuminant, cmf)
%   If traning data, illuminant and cmf is not supplied then default data will be used. 
%   Spectral Estimation using Weighted Pseudo Inverse method (Reference Paper: Babaei, V., Amirshahi, S.H. and Agahian, F., 2011. Using weighted pseudo?inverse method 
%                                                             ...for reconstruction of reflectance spectra and analyzing the dataset in terms of normality. Color Research & Application, 36(4), pp.295-305.)
%   author:          Â© Tanzima Habib
%   version:         1.1
%   date:  	         1-05-2021
%########################################################################################################################################################
% S = estimated spectra, training = training reflectances ,  test = test tristimulus values
% illuminant = illuminant D50, cmf = CIE 1931 2 degree observer
%Set training = 0 to use default training reflectance.
%########################################################################################################################################################
% Note: Training reflectance, cmf and illuminant matrices should have rows
% as wavelength and xyz_ts matrix should have rows as three tristimulus co-ordinates
%########################################################################################################################################################

function S = wpseudoInv(test, training, illuminant, cmf)
    
    %Use default training data, illuminant and cmf
    if nargin < 4
      cmf = [0.00136800000000000,3.90000000000000e-05,0.00645000100000000;0.00424300000000000,0.000120000000000000,0.0200500100000000;0.0143100000000000,0.000396000000000000,0.0678500100000000;0.0435100000000000,0.00121000000000000,0.207400000000000;0.134380000000000,0.00400000000000000,0.645600000000000;0.283900000000000,0.0116000000000000,1.38560000000000;0.348280000000000,0.0230000000000000,1.74706000000000;0.336200000000000,0.0380000000000000,1.77211000000000;0.290800000000000,0.0600000000000000,1.66920000000000;0.195360000000000,0.0909800000000000,1.28764000000000;0.0956400000000000,0.139020000000000,0.812950100000000;0.0320100000000000,0.208020000000000,0.465180000000000;0.00490000000000000,0.323000000000000,0.272000000000000;0.00930000000000000,0.503000000000000,0.158200000000000;0.0632700000000000,0.710000000000000,0.0782499900000000;0.165500000000000,0.862000000000000,0.0421600000000000;0.290400000000000,0.954000000000000,0.0203000000000000;0.433449900000000,0.994950100000000,0.00874999900000000;0.594500000000000,0.995000000000000,0.00390000000000000;0.762100000000000,0.952000000000000,0.00210000000000000;0.916300000000000,0.870000000000000,0.00165000100000000;1.02630000000000,0.757000000000000,0.00110000000000000;1.06220000000000,0.631000000000000,0.000800000000000000;1.00260000000000,0.503000000000000,0.000340000000000000;0.854449900000000,0.381000000000000,0.000190000000000000;0.642400000000000,0.265000000000000,5.00000000000000e-05;0.447900000000000,0.175000000000000,2.00000000000000e-05;0.283500000000000,0.107000000000000,0;0.164900000000000,0.0610000000000000,0;0.0874000000000000,0.0320000000000000,0;0.0467700000000000,0.0170000000000000,0;0.0227000000000000,0.00821000000000000,0;0.0113591600000000,0.00410200000000000,0;0.00579034600000000,0.00209100000000000,0;0.00289932700000000,0.00104700000000000,0;0.00143997100000000,0.000520000000000000,0];
      if nargin < 3
        illuminant = d50 = [24.4880000000000;29.8710000000000;49.3080000000000;56.5130000000000;60.0340000000000;57.8180000000000;74.8250000000000;87.2470000000000;90.6120000000000;91.3680000000000;95.1090000000000;91.9630000000000;95.7240000000000;96.6130000000000;97.1290000000000;102.099000000000;100.755000000000;102.317000000000;100;97.7350000000000;98.9180000000000;93.4990000000000;97.6880000000000;99.2690000000000;99.0420000000000;95.7220000000000;98.8570000000000;95.6670000000000;98.1900000000000;103.003000000000;99.1330000000000;87.3810000000000;91.6040000000000;92.8890000000000;76.8540000000000;86.5110000000000];
        if nargin < 2
          fname = "fogra51_380_730_10nm"; %set reference reflectance data mat file
          pathname = 'reflectance_database\';
          file = load(strcat(pathname, fname,'.mat'), fname);
          training = file.(fname);
        end
      end
    end
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    % Calculate white point
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    k = 100 / sum(cmf(2,:).*illuminant);
    wp = k .* cmf * illuminant';

    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    % Calculate the reference tristimulus values
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    k = 100 / sum(cmf(2,:).*illuminant);
    xyz_tr = (k .* cmf * diag(illuminant) * training);
    
    S = zeros(size(training,1),size(test,2));
    for i = 1: size(test,2)
         T = test(:,i);
         lab1 = xyz2lab(xyz_tr', 'whitepoint',wp');
         lab2 = xyz2lab(T', 'whitepoint',wp');
         w_xyz = sum((lab1 - lab2).^2,2); %calculate Delta Ea*b* (Lab colour difference)
         e = 0.00001;
         w_xyz = 1./(w_xyz+e); %handle division by 0 by adding e 
         w_xyz = w_xyz/max(w_xyz); %normalize
         w = diag(w_xyz);
         M = (training*w)*pinv(xyz_tr*w); %transformation matrix
         S(:,i) = M*T; %estimated spectra
    end
    S = S';
    
end
